{:title "How to include environment variables in crontab"
 :layout :post
 :tags  []
 :toc true}

As you all probably already know (from [here](http://www.golb.in/git-week-part-1-13.html)), I am currently working on a project that needs me to collect data from various online resources. Since this data needs to be collected at regular intervals (due to updates happening to the data continuously), and not in just one go, I am using cronjob scripts to collect this data.

While writing this script I faced a lot of problems, and that is what I will discuss today. In the hope that someone out there will find something important from my mistakes and learnings, and that this post may be helpful in solving similar problems for him/her too.

As always, let me first start with some background. When developing the script, my desktop was behind a proxy. Although both curl and wget have inbuilt proxy support, both of them refused to work for me. With wget, i was getting the following error:

```
Connecting to 168.219.61.252:8080... connected.
Proxy request sent, awaiting response... 403 Forbidden
2013-12-18 13:39:36 ERROR 403: Forbidden.
```

My first instinct was that the proxy is blocking the request. But I was able to download the file perfectly from browser (which also goes via the same proxy). I hit a dead end and did not know what to do next. So I searched for command line based download managers instead and found [aria2](http://aria2.sourceforge.net/) that worked fine for me. YMMV.

Before going on, let me also mention that I had the following environment variables set

```
13:47:17 ~ $ env | grep proxy
http_proxy=http://168.219.61.252:8080/
ftp_proxy=http://168.219.61.252:8080/
all_proxy=socks://http://168.219.61.250:8080/
https_proxy=http://168.219.61.252:8080/
proxy=168.219.61.252:8080
no_proxy=localhost,127.0.0.0/8,::1
```

Back to the script now. The reason I needed a script (instead of just a simple wget/aria2 command inside crontab was simply because i needed to do some pre and post-processing to the downloaded content). Anyways, that's besides the point. So lets continue.

I was ready with the script and tested it extensively, both for the download part and post-processing, and ensured that things were working fine. Then i setup crontab as follows:

```
13:47:19 ~ $ crontab -l
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (/tmp/crontab.XXXX4oqDI8 installed on Wed Dec 11 19:42:26 2013)
# (Cron version V5.0 -- $Id: crontab.c,v 1.12 2004/01/23 18:56:42 vixie Exp $)
HOME=/home/spradnyesh 0 */5 * * 1,2,3,4,5 $HOME/project/scripts/download-daily.sh 2&amp;gt;&amp;amp;1 &amp;gt; $HOME/dd.log
```

I am sure you all know what the parameters of the cronjob line mean. But I will explain them briefly just for the sake of completeness:

```
1. 0: run at 00 minutes
2. */5: run every 5 hours
3. *: run on every day of the month
4. *: run in every month
5. 1,2,3,4,5: run only on weekdays (mon,tue,wed,thurs,fri)
```

Having explained that, lets move to the script itself. It looked something like this

```
#!/bin/bash

##### initial setup
cd $HOME/project/data/
toDate=`date +%F--%H`
prefix='http://www.example.com/'
suffix='&amp;amp;a=b'
outfile='download-daily.txt'

##### download data
rm $outfile
touch $outfile
for i in `cat ../list`
do
    echo "${prefix}${i}${suffix}" &amp;gt;&amp;gt; $outfile
    echo " out=${toDate}-${i}.html" &amp;gt;&amp;gt; $outfile
done
aria2c -j 10 --allow-overwrite=true --remove-control-file=true --remove-control-file=false -i $outfile

##### do some post-processing

git add $toDate.html; git commit -am "added data for $toDate"
```

The actual details of the script don't matter. Basically, I am simply doing some initial setup, downloading the data, doing post processing including saving the new file to git (read about my previous git experiences [here](http://www.golb.in/git-week-part-1-13.html), [here](http://www.golb.in/git-week-part-2-14.html), [here](http://www.golb.in/git-week-part-3-15.html), [here](http://www.golb.in/git-week-part-4-16.html) and [here](http://www.golb.in/git-week-part-5-17.html)).

Unfortunately ([Murphy's law](http://en.wikipedia.org/wiki/Murphy%2527s_law)), the script failed to download any data. On examining closely, I found that the $http_proxy environment variable was not visible inside the script. Researching online on this issue I learnt (to learn about the difference between "learnt" and "learned", visit my previous story [here](http://www.golb.in/difference-between-learnt-and-learned-18.html)) that the environment available to a script run via cron is very limited (mostly for security reasons), which is why the $http_proxy variable was invisible inside the script.

To deal with this issue, i found a few solutions [here](http://stackoverflow.com/a/2229861), [here](http://stackoverflow.com/a/10657111), [here](http://stackoverflow.com/a/13579786) (this one (and similarly [this](http://stackoverflow.com/a/18647100) one and [this](http://stackoverflow.com/a/18647100) one) is a big NO NO for security reasons, and also due to limitations as explained [here](http://stackoverflow.com/questions/5934554/crontab-source-file#) and [here](http://stackoverflow.com/a/5935335)), but none of them seemed to work for me. What eventually worked for me was setting up my cronjob rule as follows:

```
0 */5 * * 1,2,3,4,5 env http_proxy=http://168.219.61.252:8080/ $HOME/project/scripts/download-daily.sh 2&amp;gt;&amp;amp;1 &amp;gt; $HOME/dd.log
```

Do share your experiences with setting environment variables inside of cronjob scripts. Maybe you found some other (easier) way that worked for you. I would really love to hear about it!
